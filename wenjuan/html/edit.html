<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>编辑页</title>
    <link rel='stylesheet' href='../stylesheets/vendor/bootstrap.css' />
    <link rel='stylesheet' href='../stylesheets/vendor/flat-ui.css' />
    <link rel='stylesheet' href='../stylesheets/vendor/font-awesome.css' />
    <link rel='stylesheet' href='../stylesheets/style.css' />
    <script src='../js/vendor/jquery.min.js'></script>
    <script src='../js/vendor/jquery-ui.min.js'></script>
    <script src='../js/vendor/handlebars-v3.0.0.js'></script>
</head>
<body>
<div class="container">
        <ul class="nav navbar-nav">
            <li class="active"><a href="edit.html">编辑</a></li>
            <li class=""><a href="preview">预览</a></li>
        </ul>
</div>
<div class="container">
    <div class="row">
        <div class="edit-leftwrapper">
            <ul class="draggnav" id="J-draggnav">
                <li data-change="true" data-type="radio"><span class="fui-radio-checked"></span>单选题</li>
                <li data-change="true" data-type="checkbox"><span class="fui-checkbox-checked"></span>多选题</li>
                <li data-change="true" data-type="img-radio"><span class="fui-image"></span>图片单选题</li>
                <li data-change="true" data-type="img-checkbox"><span class="fui-image"></span>图片多选题</li>
                <li data-change="true" data-type="single-input"><span>A</span>单行填空题</li>
                <li data-change="true" data-type="multi-input"><span class="fui-list-columned"></span>多项填空题</li>
                <li data-change="true" data-type="textarea"><span class="fui-folder"></span>多行填空题</li>
                <li data-change="true" data-type="score"><span class="fui-star-2"></span>打分题</li>
                <li data-change="true" data-type="matrix-radio"><span class="fui-list-numbered"></span>矩阵单选题</li>
                <li data-change="true" data-type="matrix-checkbox"><span class="fui-list-numbered"></span>矩阵多选题</li>
                <li data-change="true" data-type="matrix-input"><span class="fui-list-numbered"></span>矩阵填空题</li>
                <li data-change="true" data-type="info"><span class="fui-tag"></span>段落说明</li>
                <!--
                <li data-change="true" data-type="pagination"><span class="fui-clip"></span>分页</li>-->
            </ul>
        </div>
        <div class="edit-rightwrapper">
            <div class='panel panel-default J-pagetitle'>
                <div class='panel-heading'>
                    <label>问卷标题</label>
                    <input name="main_title" placeholder="填写标题" class="J-titlebind"/>
                </div>
                <div class='panel-body' style="height:100px;">
                    <label>问卷描述</label>
                    <textarea name="sub_title" placeholder="填写描述" class="J-titlebind"></textarea>
                </div>
            </div>
            <ul class="sortnav" id="J-sortarea">
            </ul>

        </div>
    
    </div>
</div>

<style>
    .fui-plus-circle, .fui-cross-circle{cursor:pointer;}
    .panel-heading .title-order {margin-right:20px;}
    .panel-heading input{font-size:14px;width:50%;}
    .panel-body table {font-size:14px;}
    .panel-body .fui-plus-circle, .panel-body .fui-cross-circle {margin-left:10px;}
</style>


<script type="text/html" id="M-radio">
    <label class="radio">
        <input type="radio" /><input type="text" name="radio_st" placeholder="填写选项" value="选项1"/>
    </label>
    <label class="radio">
        <input type="radio" /><input type="text" name="radio_st" placeholder="填写选项" value="选项2"/>
    </label>
    <span class="fui-plus-circle J-plus"></span>
    <p>这是一道单选题，请设置问题和选项</p>
</script>
<script type="text/html" id="M-checkbox">
    <label class="checkbox">
        <input type="checkbox" /><input type="text" name="checkbox_st" placeholder="填写选项" value="选项1"/>
    </label>
    <label class="checkbox">
        <input type="checkbox" /><input type="text" name="checkbox_st" placeholder="填写" value="选项2"/>
    </label>
    <span class="fui-plus-circle J-plus"></span>
    <p>这是一道多选题，请设置问题和选项</p>
</script>
<script type="text/html" id="M-img-radio">
    <div class="img-area">
        <img src="../images/test/icon_tel.png" width=140 height=140/>
        <label class="radio">
            <input type="radio" /><input type="text" name="img_radio_st" placeholder="填写选项" value="选项1"/>
        </label>
        
    </div>
    <div class="img-area uploader">
        <input type="file" name="files[]" title="点击添加图片"/>
        <span class="fui-image"></span>
    </div>
</script>
<script type="text/html" id="M-img-checkbox">
    <div class="img-area">
        <img src="../images/test/icon_tel.png" width=140 height=140/>
        <label class="checkbox">
            <input type="checkbox" /><input type="text" name="img_checkbox_st" placeholder="填写选项" value="选项1"/>
        </label>
        
    </div>
    <div class="img-area uploader">
        <input type="file" name="files[]" title="点击添加图片"/>
        <span class="fui-image"></span>
    </div>
</script>
<script type="text/html" id="M-single-input">
    <input type="aee" disabled/>
</script>
<script type="text/html" id="M-multi-input">
    <label class="radio">
        <input placeholder="选项一" type="text" name="multi_input_st" value="选项一" />
        <input type="aee" disabled/>
    </label>
    <label class="radio">
        <input placeholder="选项二" type="text" name="multi_input_st" value="选项二" />
        <input type="aee" disabled/>
    </label>
    <span class="fui-plus-circle J-plus"></span>
</script>
<script type="text/html" id="M-textarea">
    <textarea disabled></textarea>
</script>
<script type="text/html" id="M-score">
    <label class="score-area radio">
        <input type="text" placeholder="填写选项" name="score_st" value="选项1" class="score-area-left"/>
        <div class="score-area-right">
            <span class="fui-star-2" style="color:grey"></span>
            <span class="fui-star-2" style="color:grey"></span>
            <span class="fui-star-2"></span>
            <span class="fui-star-2"></span>
            <span class="fui-star-2"></span>
        </div>
    </label>
    <label class="score-area radio">
        <input type="text" placeholder="填写选项" name="score_st" value="选项2" class="score-area-left"/>
        <div class="score-area-right">
            <span class="fui-star-2" style="color:grey"></span>
            <span class="fui-star-2" style="color:grey"></span>
            <span class="fui-star-2"></span>
            <span class="fui-star-2"></span>
            <span class="fui-star-2"></span>
        </div>
    </label>

    <span class="fui-plus-circle J-plus"></span>
</script>
<script type="text/html" id="M-matrix-radio">
    <table class="table table-bordered">
        <thead>
            <tr>
                <th></th>
                <th><input type="text" placeholder="填写选项" value="选项一" /></th>
                <th><input type="text" placeholder="填写选项" value="选项二" /></th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><input type="text" placeholder="填写行名" value="行名" /></td>
                <td><input type="radio"/ ></td>
                <td><input type="radio"/ ></td>
            </tr>
            <tr>
                <td><input type="text" placeholder="填写行名" value="行名" /></td>
                <td><input type="radio"/ ></td>
                <td><input type="radio"/ ></td>
            </tr>

        </tbody>
    </table>

    <span class="fui-plus-circle J-plus" data-type="line">增加行</span>
    <span class="fui-plus-circle J-plus" data-type="row">增加列</span>
</script>
<script type="text/html" id="M-matrix-checkbox">
    <table class="table table-bordered">
        <thead>
            <tr>
             <th></th>
                <th><input type="text" placeholder="填写选项" value="选项一" /></th>
                <th><input type="text" placeholder="填写选项" value="选项二" /></th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><input type="text" placeholder="填写行名" value="行名" /></td>
                <td><input type="checkbox"/ ></td>
                <td><input type="checkbox"/ ></td>
            </tr>
            <tr>
                <td><input type="text" placeholder="填写行名" value="行名" /></td>
                <td><input type="checkbox"/ ></td>
                <td><input type="checkbox"/ ></td>
            </tr>
        </tbody>
    </table>
    <span class="fui-plus-circle J-plus" data-type="line">增加行</span>
    <span class="fui-plus-circle J-plus" data-type="row">增加列</span>
</script>
<script type="text/html" id="M-matrix-input">
    <table class="table table-bordered">
        <thead>
            <tr>
                <th></th>
                <th><input type="text" placeholder="填写选项" value="选项一" /></th>
                <th><input type="text" placeholder="填写选项" value="选项二" /></th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><input type="text" placeholder="填写行名" value="行名" /></td>
                <td><input type="aee" disabled /></td>
                <td><input type="aee" disabled /></td>
            </tr>
            <tr>
                <td><input type="text" placeholder="填写行名" value="行名" /></td>
                <td><input type="aee" disabled /></td>
                <td><input type="aee" disabled /></td>
            </tr>
        </tbody>
    </table>
    <span class="fui-plus-circle J-plus" data-type="line">增加行</span>
    <span class="fui-plus-circle J-plus" data-type="row">增加列</span>
</script>
<script type="text/html" id="M-info">
</script>
<script type="text/html" id="M-pagination">
</script>
<script type="text/html" id="M-pannel">
    <div class='panel panel-default'>
        <div class='panel-heading'>
            <span class="title-order J-order"></span>
            <input type="text" placeholder="填写标题" name="title" value="填写标题"/>
            <div class="fr action-area">
                <span class="fui-triangle-up"></span>    
                <span class="fui-triangle-down"></span>    
                <span class="fui-trash"></span>    
                <label class="checkbox" style="width:60px;margin-top:20px;">
                    <input type="checkbox" value="" data-toggle="checkbox" class="custom-checkbox J-must"><span class="icons"><span class="icon-unchecked"></span><span class="icon-checked"></span></span>
                    必答
                </label>
            </div>
        </div>
       <div class='panel-body'>
       </div>
    </div>
</script>

<script>
$(function() {
    /*左侧拖拉*/
    $('#J-draggnav li').draggable({
        connectToSortable: '#J-sortarea',
        addClasses: false,
        helper: 'clone',
        cursor: "move",
        revert: 'invalid',
        stop: function(event, ui){
            rebuild('#J-sortarea');
        }
    });

    $("#J-draggnav").delegate("li","click",function(){
        $('#J-sortarea').append($(this).clone());
        rebuild('#J-sortarea');
        resort('#J-sortarea');
        $('body').animate({scrollTop: $('#J-sortarea').height()}, 500);
    });

    /*右侧排序*/
    $('#J-sortarea').sortable({
        handle: ".panel-heading",
        cursor: "move",
        revert: true,
        stop: function(event, ui){
            resort('#J-sortarea');
        }
    });


    /*重建右侧*/
    function rebuild(id) {
        $(id).children('li').each(function() {
            // 遍历子节点，转化刚刚加入的项目
            if ($(this).attr('data-type') && $(this).attr('data-change') == 'true') {
                $(this).attr('data-change', false);
                switchbuild($(this));
           }
        });
    }


    /*右侧序列生成*/
    function resort(id) {
        var count = 1,
            order_list = [];
        $(id).children('li').each(function() {
            if ($(this).attr('data-type')) {
                order_list.push($(this).attr('id'));
                $(this).find('.J-order').html('Q' + count++);
            }
        });
        // 每次操作以后输出序列顺序
        console.log('发送序列顺序:' + order_list);
    }

    /*节点转化*/
    function switchbuild(node) {
        var type = node.attr('data-type'),
            d = new Date().getTime();
        node.attr('id', 'J-wj' + d);
        var pannel = $($('#M-pannel').html());
        pannel.find('.panel-body').html($('#M-' + type).html());

        node.html('');
        node.append(pannel);
        node.css('width', '100%');
        node.css('height', '');

        console.log('新添加项目:' + node.attr('data-type') + ' id:' + node.attr('id')); 
    }


    $("#J-sortarea").delegate(".fui-triangle-up","click",function(){
        var node = $(this).parents('li'),
            node_prev = node.prev(),
            id = node.attr('id');

        node.insertBefore(node_prev);
        resort('#J-sortarea');
        console.log('------' + id + '向上调整');
    });


    $("#J-sortarea").delegate(".fui-triangle-down","click",function(){
        var node = $(this).parents('li'),
            node_next = node.next(),
            id = node.attr('id');

        node.insertAfter(node_next);
        resort('#J-sortarea');
        console.log('------' + id + '向下调整');
    });

    $("#J-sortarea").delegate(".fui-trash","click",function(){
        var node = $(this).parents('li'),
        id = node.attr('id');
        node.remove();

        resort('#J-sortarea');
        console.log('------' + id + '删除');
    });
    $("#J-sortarea").delegate(".J-must","click",function(){
        var node = $(this).parents('li'),
            id = node.attr('id');
        console.log('------' + id + '必答调整' + $(this).prop('checked'));
    });

    /*
        修改input等 
    */
    $('#J-sortarea').on('focusin focusout', 'input[type="text"]', function(event){
        var node = $(this).parents('li');
        var id = node.attr('id');
        if(event.type === 'focusin'){
            $(this).css('background-color', 'yellow');
            //default_input_value = $(this).val();
            //jQuery(this).val('');
            console.log('====== 进入');
        }else if(event.type === 'focusout'){
            $(this).css('background-color', 'white');
            console.log('====== 离开 ====== 修改 id:' + id + '下input "' + $(this).attr('name') +  '" 值为 "' + $(this).val() + '"');
        }
    });

    $('.J-pagetitle').on('focusin focusout', '.J-titlebind', function(event){
        if(event.type === 'focusin'){
            $(this).css('background-color', 'yellow');
            console.log('====== 进入');
        }else if(event.type === 'focusout'){
            $(this).css('background-color', 'white');
            console.log('====== 离开 ====== 修改 "' + $(this).attr('name') +  '" 值为 "' + $(this).val() + '"');
        }
    });

    /*
        设置添加
    */
    $("#J-sortarea").delegate(".J-plus","click",function(){
        var node = $(this).parents('li'),
            id = node.attr('id');

            console.log(node.attr('data-type'));
        if (node.attr('data-type').indexOf('matrix') >= 0) {
            var table = node.find('table');
            if ($(this).attr('data-type') == 'line') {
                table.find('tbody').append(table.find('tbody tr:last-child').clone());
                if (table.find('tbody tr:last-child').find('.fui-cross-circle').length == 0) {
                    //table.find('tbody tr:last-child').append($("<span class='fui-cross-circle J-minus'></span>"));
                }
            } else {
                table.find('thead tr').append($('<th><input type="text" placeholder="填写选项" value="新选项" /></th>'));
                table.find('tbody tr').append(table.find('tbody tr:last-child td:last-child').clone());
        
            }
        
        } else {
            $($(this).prev().clone()).insertBefore($(this));
            $(this).prev().find('input[type=text]').val('新选项');
            if ($(this).prev().find('.fui-cross-circle').length == 0) {
                $(this).prev().append($("<span class='fui-cross-circle J-minus'></span>"));
            }
        }

        console.log('++++++ ' + id + ' 添加项目');
    });

    /*
        设置必答题
    */
    $("#J-sortarea").delegate(".J-minus","click",function(){
        var node = $(this).parents('li'),
        id = node.attr('id');

        console.log('------ ' + id + ' 删除项目 "' + $(this).parent().find('input[type=text]').val() + '"');

        $(this).parent().remove();
    });

});
</script>
</body>
</html>
